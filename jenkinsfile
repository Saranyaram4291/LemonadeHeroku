pipeline {
    agent any
tools {
    maven 'M3'
	jdk 'jdk1.8'
  } 
environment {
	PATH="${env.PATH}:${tool 'M3'}/bin:${tool 'jdk1.8'}/bin"
	JAVA_HOME="${tool 'jdk1.8'}"
	MAVEN_HOME="${tool 'M3'}"
}  
stages{
		stage('Init'){
            steps {
				echo 'Initialized'
				// Get code from a code cloud            
				git branch: 'develop_1908',
					credentialsId: 'git_kd0736',
					url: 'https://m16663@codecloud.web.att.com/scm/st_ssdfms1/myprice.git'
            }
            post {
                success {
                    echo 'Success'
                }
            }
        }		
        stage('Build'){
            steps {
			    wrap([$class: 'ConfigFileBuildWrapper', managedFiles: [[fileId: 'MyPriceMavenSettings.xml', variable: 'MAVEN_SETTINGS'],]]) {
					echo 'Building'
					sh 'mvn -DskipTests -Dmaven.test.skip=true -s $MAVEN_SETTINGS clean compile' 
				}
			}
			post{
				success {
						echo 'Compilation Completed.'
				}
				failure {		  
				    sh 'echo "Dear All, \n\n\t The build for Lemonade Automation Code has failed. Please fix it urgently. Below is build URL. \n\t\t ${env.BUILD_URL} \n\nRegards, \n   Your Automation Buddy\n\n" > /tmp/automation${BUILD_NUMBER}.txt'
					sh 'cat /tmp/automation${BUILD_NUMBER}.txt | /bin/mailx -s "[ Build Failure ] ]MyPrice Automation Test Build Failed-`date +%d_%m_%Y`.`date +%H.%M.%S`" -c "vk3768@att.com" "MYPriceRDCST@wwpdl.vnet.ibm.com"'
					sh "rm /tmp/automation${BUILD_NUMBER}.txt"
				}
			}
        }
		stage('Test'){
            steps {
				wrap([$class: 'ConfigFileBuildWrapper', managedFiles: [[fileId: 'MyPriceMavenSettings.xml', variable: 'MAVEN_SETTINGS'],]]) {
					echo 'Executing Test cases'
					sh 'mvn -s $MAVEN_SETTINGS -Dapplication.configuration.file=./src/test/resources/properties/Config.properties.jenkins -Dremote.run.chromehub.enabled=Y -Dchrome.driver.options.headless=N test' 
				}
            }
            post {  
				always {  
					echo "Sending Test Results in email."
					sh "export DATE_STRING=`date +%d_%m_%Y`.`date +%H.%M.%S`"
					sh 'echo "Dear All, \n\n\t Please find below the attached MyPrice Automation Report. \n\nRegards, \n   Your Automation Buddy\n\n" > /tmp/automation${BUILD_NUMBER}.txt'
					sh 'cat /tmp/automation${BUILD_NUMBER}.txt | /bin/mailx -s "MyPrice Automation Test Run Report-`date +%d_%m_%Y`.`date +%H.%M.%S`" -a ./target/surefire-reports/html/MyPriceAutomationReport.html -c "vk3768@att.com" "MYPriceRDCST@wwpdl.vnet.ibm.com, tjprasan@in.ibm.com, chandrasekhar.gubili@in.ibm.com, askharch@in.ibm.com, dsuman@in.ibm.com, tk576s@att.com"'
					sh "rm /tmp/automation${BUILD_NUMBER}.txt"	
					
					emailext attachLog: true,
     					body: "${currentBuild.currentResult}: Job ${env.JOB_NAME} build ${env.BUILD_NUMBER}\n More info at: ${env.BUILD_URL}",
     					to: "sk7787@att.com, vk3768@att.com, ak0615@att.com, tk576s@att.com",
     					subject: "Jenkins Build ${currentBuild.currentResult}: Job ${env.JOB_NAME}"		
				}
			} 
        }
    }
}
